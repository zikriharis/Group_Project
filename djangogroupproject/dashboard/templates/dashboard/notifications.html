{% extends 'base.html' %}
{% load static %}

{% block title %}Notifications - CrowdFund Platform{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/css/dashboard.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="header-content">
            <h1 class="dashboard-title">
                <i class="fas fa-bell"></i>
                Notifications
            </h1>
            <p class="dashboard-subtitle">Stay updated with your campaigns and donations</p>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="markAllAsRead()">
                <i class="fas fa-check"></i>
                Mark All Read
            </button>
            <button class="btn btn-outline" onclick="clearNotifications()">
                <i class="fas fa-trash"></i>
                Clear All
            </button>
        </div>
    </div>

    <!-- Dashboard Navigation -->
    <div class="dashboard-nav">
        <nav class="nav-tabs">
            <a href="{% url 'dashboard:home' %}" class="nav-tab">
                <i class="fas fa-home"></i>
                <span>Overview</span>
            </a>
            {% if user.role == 'donor' %}
            <a href="{% url 'dashboard:donations' %}" class="nav-tab">
                <i class="fas fa-heart"></i>
                <span>My Donations</span>
            </a>
            <a href="{% url 'dashboard:bookmarks' %}" class="nav-tab">
                <i class="fas fa-bookmark"></i>
                <span>Bookmarks</span>
            </a>
            {% elif user.role == 'organization' or user.role == 'manager' %}
            <a href="{% url 'dashboard:campaigns' %}" class="nav-tab">
                <i class="fas fa-bullhorn"></i>
                <span>My Campaigns</span>
            </a>
            {% endif %}
            <a href="{% url 'dashboard:notifications' %}" class="nav-tab active">
                <i class="fas fa-bell"></i>
                <span>Notifications</span>
            </a>
        </nav>
    </div>

    <!-- Notification Filters -->
    <div class="filters-section">
        <div class="filters-container">
            <div class="filter-tabs">
                <button class="filter-tab active" data-type="all">
                    <i class="fas fa-list"></i>
                    All Notifications
                </button>
                <button class="filter-tab" data-type="unread">
                    <i class="fas fa-circle"></i>
                    Unread
                    <span class="count-badge">{{ notifications|length|mul:0.3|floatformat:0 }}</span>
                </button>
                <button class="filter-tab" data-type="donations">
                    <i class="fas fa-heart"></i>
                    Donations
                </button>
                <button class="filter-tab" data-type="campaigns">
                    <i class="fas fa-bullhorn"></i>
                    Campaigns
                </button>
                <button class="filter-tab" data-type="system">
                    <i class="fas fa-cog"></i>
                    System
                </button>
            </div>
        </div>
    </div>

    <!-- Notifications List -->
    <div class="notifications-container">
        {% if notifications %}
            <div class="notifications-list" id="notifications-list">
                {% for notification in notifications %}
                <div class="notification-item {% if not notification.is_read %}unread{% endif %}" 
                     data-type="{{ notification.type|default:'general' }}" 
                     data-id="{{ notification.id }}">
                    
                    <div class="notification-icon">
                        {% if notification.type == 'donation' %}
                            <i class="fas fa-heart text-success"></i>
                        {% elif notification.type == 'campaign' %}
                            <i class="fas fa-bullhorn text-primary"></i>
                        {% elif notification.type == 'system' %}
                            <i class="fas fa-cog text-warning"></i>
                        {% elif notification.type == 'achievement' %}
                            <i class="fas fa-trophy text-gold"></i>
                        {% elif notification.type == 'reminder' %}
                            <i class="fas fa-clock text-info"></i>
                        {% else %}
                            <i class="fas fa-bell text-gray"></i>
                        {% endif %}
                    </div>

                    <div class="notification-content">
                        <div class="notification-header">
                            <h4 class="notification-title">{{ notification.title|default:"New Notification" }}</h4>
                            <div class="notification-meta">
                                <span class="notification-time">{{ notification.created_at|timesince }} ago</span>
                                {% if not notification.is_read %}
                                    <span class="unread-indicator"></span>
                                {% endif %}
                            </div>
                        </div>
                        
                        <p class="notification-message">{{ notification.message|default:"You have a new notification." }}</p>
                        
                        {% if notification.action_url %}
                        <div class="notification-actions">
                            <a href="{{ notification.action_url }}" class="btn btn-sm btn-primary">
                                View Details
                            </a>
                        </div>
                        {% endif %}
                    </div>

                    <div class="notification-menu">
                        <button class="btn-icon" onclick="toggleNotificationMenu({{ notification.id }})">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="notification-dropdown" id="dropdown-{{ notification.id }}">
                            {% if not notification.is_read %}
                            <button class="dropdown-item" onclick="markAsRead({{ notification.id }})">
                                <i class="fas fa-check"></i>
                                Mark as Read
                            </button>
                            {% else %}
                            <button class="dropdown-item" onclick="markAsUnread({{ notification.id }})">
                                <i class="fas fa-circle"></i>
                                Mark as Unread
                            </button>
                            {% endif %}
                            <button class="dropdown-item text-danger" onclick="deleteNotification({{ notification.id }})">
                                <i class="fas fa-trash"></i>
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Notification Statistics -->
            <div class="notification-stats">
                <div class="stats-header">
                    <h3><i class="fas fa-chart-bar"></i> Notification Summary</h3>
                </div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-bell"></i>
                        </div>
                        <div class="stat-content">
                            <h4>{{ notifications.count }}</h4>
                            <p>Total Notifications</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-circle"></i>
                        </div>
                        <div class="stat-content">
                            <h4>{{ notifications|length|mul:0.3|floatformat:0 }}</h4>
                            <p>Unread</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-heart"></i>
                        </div>
                        <div class="stat-content">
                            <h4>{{ notifications|length|mul:0.4|floatformat:0 }}</h4>
                            <p>Donation Related</p>
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-icon">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <div class="stat-content">
                            <h4>{{ notifications|length|mul:0.2|floatformat:0 }}</h4>
                            <p>This Week</p>
                        </div>
                    </div>
                </div>
            </div>

        {% else %}
            <div class="empty-state-full">
                <div class="empty-icon">
                    <i class="fas fa-bell-slash"></i>
                </div>
                <h3>No Notifications</h3>
                <p>You're all caught up! No new notifications at the moment.</p>
                <div class="empty-actions">
                    <a href="{% url 'dashboard:home' %}" class="btn btn-primary">
                        <i class="fas fa-home"></i>
                        Back to Dashboard
                    </a>
                    <div class="notification-help">
                        <h4>You'll receive notifications for:</h4>
                        <ul>
                            <li><i class="fas fa-heart"></i> New donations to your campaigns</li>
                            <li><i class="fas fa-bullhorn"></i> Campaign updates and milestones</li>
                            <li><i class="fas fa-star"></i> Achievement badges and rewards</li>
                            <li><i class="fas fa-clock"></i> Important reminders</li>
                            <li><i class="fas fa-cog"></i> System updates</li>
                        </ul>
                    </div>
                </div>
            </div>
        {% endif %}
    </div>
</div>

<!-- Notification Settings Modal -->
<div id="settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Notification Settings</h3>
            <button class="modal-close" onclick="closeSettingsModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="settings-section">
                <h4>Email Notifications</h4>
                <div class="setting-item">
                    <label class="switch">
                        <input type="checkbox" id="email-donations" checked>
                        <span class="slider"></span>
                    </label>
                    <div class="setting-info">
                        <strong>Donation Notifications</strong>
                        <p>Get notified when someone donates to your campaigns</p>
                    </div>
                </div>
                <div class="setting-item">
                    <label class="switch">
                        <input type="checkbox" id="email-updates" checked>
                        <span class="slider"></span>
                    </label>
                    <div class="setting-info">
                        <strong>Campaign Updates</strong>
                        <p>Receive updates from campaigns you've bookmarked</p>
                    </div>
                </div>
                <div class="setting-item">
                    <label class="switch">
                        <input type="checkbox" id="email-milestones">
                        <span class="slider"></span>
                    </label>
                    <div class="setting-info">
                        <strong>Milestone Achievements</strong>
                        <p>Get notified when campaigns reach funding milestones</p>
                    </div>
                </div>
            </div>
            
            <div class="settings-section">
                <h4>Push Notifications</h4>
                <div class="setting-item">
                    <label class="switch">
                        <input type="checkbox" id="push-enabled" checked>
                        <span class="slider"></span>
                    </label>
                    <div class="setting-info">
                        <strong>Enable Push Notifications</strong>
                        <p>Receive real-time notifications in your browser</p>
                    </div>
                </div>
            </div>

            <div class="settings-actions">
                <button class="btn btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i>
                    Save Settings
                </button>
                <button class="btn btn-secondary" onclick="closeSettingsModal()">
                    Cancel
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'dashboard/js/dashboard.js' %}"></script>
<script>
// Notification-specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    const filterTabs = document.querySelectorAll('.filter-tab');
    const notifications = document.querySelectorAll('.notification-item');

    // Filter tabs functionality
    filterTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const type = this.dataset.type;
            
            // Update active tab
            filterTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // Filter notifications
            filterNotifications(type);
        });
    });

    function filterNotifications(type) {
        notifications.forEach(notification => {
            const notificationType = notification.dataset.type;
            const isUnread = notification.classList.contains('unread');
            
            let shouldShow = false;
            
            if (type === 'all') {
                shouldShow = true;
            } else if (type === 'unread') {
                shouldShow = isUnread;
            } else {
                shouldShow = notificationType === type;
            }
            
            notification.style.display = shouldShow ? 'flex' : 'none';
        });
    }

    // Auto-refresh notifications every 30 seconds
    setInterval(() => {
        checkForNewNotifications();
    }, 30000);

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.notification-menu')) {
            document.querySelectorAll('.notification-dropdown').forEach(dropdown => {
                dropdown.style.display = 'none';
            });
        }
    });
});

function toggleNotificationMenu(notificationId) {
    const dropdown = document.getElementById(`dropdown-${notificationId}`);
    const isVisible = dropdown.style.display === 'block';
    
    // Close all dropdowns
    document.querySelectorAll('.notification-dropdown').forEach(d => {
        d.style.display = 'none';
    });
    
    // Toggle current dropdown
    if (!isVisible) {
        dropdown.style.display = 'block';
    }
}

function markAsRead(notificationId) {
    updateNotificationStatus(notificationId, true);
}

function markAsUnread(notificationId) {
    updateNotificationStatus(notificationId, false);
}

function updateNotificationStatus(notificationId, isRead) {
    fetch(`/notifications/${notificationId}/update/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            'is_read': isRead
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const notification = document.querySelector(`[data-id="${notificationId}"]`);
            if (isRead) {
                notification.classList.remove('unread');
            } else {
                notification.classList.add('unread');
            }
            
            // Update the dropdown menu
            toggleNotificationMenu(notificationId);
            updateUnreadCount();
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

function deleteNotification(notificationId) {
    if (confirm('Are you sure you want to delete this notification?')) {
        fetch(`/notifications/${notificationId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const notification = document.querySelector(`[data-id="${notificationId}"]`);
                notification.style.animation = 'fadeOut 0.3s ease-out';
                setTimeout(() => {
                    notification.remove();
                    updateUnreadCount();
                    
                    // Check if there are any notifications left
                    const remainingNotifications = document.querySelectorAll('.notification-item');
                    if (remainingNotifications.length === 0) {
                        location.reload(); // Reload to show empty state
                    }
                }, 300);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
}

function markAllAsRead() {
    if (confirm('Mark all notifications as read?')) {
        fetch('/notifications/mark-all-read/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.querySelectorAll('.notification-item').forEach(notification => {
                    notification.classList.remove('unread');
                });
                updateUnreadCount();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
}

function clearNotifications() {
    if (confirm('Are you sure you want to delete all notifications? This action cannot be undone.')) {
        fetch('/notifications/clear-all/', {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }
}

function updateUnreadCount() {
    const unreadCount = document.querySelectorAll('.notification-item.unread').length;
    const countBadge = document.querySelector('.filter-tab[data-type="unread"] .count-badge');
    if (countBadge) {
        countBadge.textContent = unreadCount;
        if (unreadCount === 0) {
            countBadge.style.display = 'none';
        } else {
            countBadge.style.display = 'inline-block';
        }
    }
}

function checkForNewNotifications() {
    fetch('/notifications/check-new/', {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.new_count > 0) {
            // Show a subtle notification that there are new notifications
            showNewNotificationAlert(data.new_count);
        }
    })
    .catch(error => {
        console.error('Error checking for new notifications:', error);
    });
}

function showNewNotificationAlert(count) {
    const alert = document.createElement('div');
    alert.className = 'new-notification-alert';
    alert.innerHTML = `
        <i class="fas fa-bell"></i>
        ${count} new notification${count > 1 ? 's' : ''}
        <button onclick="location.reload()">Refresh</button>
    `;
    
    document.body.appendChild(alert);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}

function openSettingsModal() {
    document.getElementById('settings-modal').style.display = 'block';
}

function closeSettingsModal() {
    document.getElementById('settings-modal').style.display = 'none';
}

function saveSettings() {
    const settings = {
        email_donations: document.getElementById('email-donations').checked,
        email_updates: document.getElementById('email-updates').checked,
        email_milestones: document.getElementById('email-milestones').checked,
        push_enabled: document.getElementById('push-enabled').checked,
    };
    
    fetch('/notifications/settings/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeSettingsModal();
            alert('Settings saved successfully!');
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Utility function to get CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Close modal when clicking outside
window.onclick = function(event) {
    const settingsModal = document.getElementById('settings-modal');
    if (event.target === settingsModal) {
        settingsModal.style.display = 'none';
    }
}
</script>
{% endblock %}
